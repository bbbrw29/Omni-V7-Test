<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VIP STEALTH PRO - INTEGRATED</title>
<style>
:root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --blue: #58a6ff; --gold: #ffd700; --silver: #8b949e; --green: #238636; --red: #f85149; --mint: #2ecc71; }
body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 8px; margin: 0; overflow-x: hidden; }
.container { max-width: 420px; margin: auto; }
.panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 8px; }
h4 { margin: 0 0 5px 0; color: var(--gold); border-bottom: 1px solid var(--border); padding-bottom: 5px; font-size: 10px; }

/* Prediction Display */
#predDisplay { font-size: 50px; font-weight: bold; color: var(--blue); text-shadow: 0 0 10px rgba(88, 166, 255, 0.3); }

/* Live Card Styling */
.live-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.live-card { padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: #1c2128; position: relative; transition: 0.3s; }
.current-lock { border: 2px solid #ffffff !important; box-shadow: 0 0 15px rgba(255,255,255,0.2); transform: scale(1.02); z-index: 2; }
.unlocked-card { opacity: 0.6; }

/* Comparison Monitor */
.three-layer-monitor { display: flex; gap: 2px; padding: 6px; background: rgba(0,0,0,0.4); border-radius: 6px; overflow-x: auto; min-height: 48px; }
.cell-stack { display: flex; flex-direction: column; gap: 3px; align-items: center; min-width: 22px; }
.comp-dot { width: 5px; height: 5px; border-radius: 50%; }
.res-cell { width: 100%; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }

/* History Table */
.history-container { height: 250px; overflow-y: auto; background: #080a0d; border-radius: 8px; border: 1px solid var(--border); margin-top: 5px; }
table { width: 100%; border-collapse: collapse; font-size: 11px; }
th { position: sticky; top: 0; background: #111; padding: 8px; color: var(--gold); border-bottom: 1px solid var(--border); }
td { padding: 7px 4px; border-bottom: 1px solid #1c2128; text-align: center; }

/* Buttons */
.num-btn { height: 45px; background: #21262d; border: 1px solid var(--border); color: #fff; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
.copy-btn { background: var(--blue); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer; }
</style>
</head>
<body>
<div class="container">
    <div class="panel" style="text-align: center; border: 2px solid var(--gold); background: #000;">
        <div id="predDisplay">-</div>
        <div id="statusLabel" style="font-size:10px; color:var(--gold); margin-bottom: 10px;">WAITING...</div>
        <div class="step-grid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin-bottom: 10px;">
            <script>for(let i=0;i<8;i++) document.write('<div class="step-box" style="height:20px; border:1px solid #333; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; background:#111;" id="step-'+i+'">'+(i+1)+'</div>');</script>
        </div>
        <div id="recentDisplay" style="display: flex; gap: 8px; justify-content: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;"></div>
    </div>

    <div class="panel">
        <h4>LIVE ANALYSIS (REF: LIVE/LOG)</h4>
        <div id="liveMonitor" class="live-grid"></div>
    </div>

    <div class="panel">
        <div class="numpad-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;">
            <script>for(let i=1; i<=9; i++) document.write(`<button class="num-btn" onclick="handleInput(${i})">${i}</button>`);</script>
            <button class="num-btn" onclick="handleInput(0)">0</button>
            <button class="num-btn" style="grid-column: span 5; height: 35px; background:#333; color:var(--gold); font-size:12px;" onclick="undoInput()">UNDO</button>
        </div>
        <button onclick="resetData()" style="width:100%; background:var(--red); color:white; border:none; padding:10px; border-radius:8px; font-size:12px; font-weight:bold; margin-top:8px;">RESET ALL</button>
    </div>

    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <h4>HISTORY LOG</h4>
            <button class="copy-btn" onclick="copyHistory()">COPY</button>
        </div>
        <div class="history-container">
            <table>
                <thead><tr><th>S/N</th><th>CAT</th><th>RESULT</th><th>STAT</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const myPatterns = { "00": "SBSSSSBS", "01": "SBBSBSBB", "02": "BBSBSSSS", "03": "BSBSSSBB", "04": "SSBBBBSB", "05": "BSSBBSSS", "06": "SBBBBBSB", "07": "BBBBBBSS", "08": "BSSSBBBB", "09": "SSSSSSSB", "10": "BSBSBBBS", "11": "SBBSSSBS", "12": "BSSSBSSS", "13": "BBSBSSBB", "14": "BBBSBBBS", "15": "SBSBSBSB", "16": "SBSSBSBS", "17": "BSSBBBBB", "18": "BBSSSBSB", "19": "BSSBBBBB", "20": "BBBBBBBB", "21": "BBBSSSSB", "22": "SBSSSSSS", "23": "BSBSBBSB", "24": "BSBSBSBB", "25": "BBSBBSSB", "26": "SBSBSSBB", "27": "SSBBBBSB", "28": "SBBBSBSB", "29": "SBSBSBSB", "30": "SSSBSBSS", "31": "SSSBBBBS", "32": "BBBBBBBS", "33": "BSSBSSBS", "34": "BBBSSBSB", "35": "BBSSBSSS", "36": "SSBBSBBB", "37": "BSBBSBSB", "38": "BSBBBSBB", "39": "SSSBBSSB", "40": "BBBSSSSB", "41": "SBSSBSSS", "42": "BBSBSBBB", "43": "BBSBBBSB", "44": "SSBBSSBB", "45": "SBBSBBSB", "46": "SSSBBSBS", "47": "SBBSBBBB", "48": "BSSSSSBB", "49": "BBBSSBBB", "50": "BSSBBBBS", "51": "BBSBSBBB", "52": "SSBBSSSS", "53": "SSBSBBSS", "54": "SBBBSSSS", "55": "SSSSSSSS", "56": "BBBSBBBS", "57": "BBBSSSBB", "58": "SBSBSSSB", "59": "BBSBSBBB", "60": "SBBSBBSB", "61": "SBBSBSSB", "62": "BBBBBBSS", "63": "SBSSBSBB", "64": "BBSSSSBB", "65": "BSBBBSBS", "66": "BSBSSBSB", "67": "BSSBSBSS", "68": "BBBBSBBS", "69": "BBSSSBSS", "70": "SSSBBSSB", "71": "BBBBSSBB", "72": "BSBBBSSB", "73": "BBBBBSBS", "74": "BBBSBSSB", "75": "SSBBBSBS", "76": "SSSSSBBS", "77": "SSBBBSBS", "78": "BBBBBBSS", "79": "BSBBBSSS", "80": "BBSSBBSS", "81": "BSSSBSBS", "82": "BBBSBSSB", "83": "BSSSSBSS", "84": "BBSBBSBB", "85": "SSBBBSBB", "86": "BBSBSSBB", "87": "BBSSBSSS", "88": "SSBSSBBS", "89": "BBSSBSBB", "90": "SBBSSSSS", "91": "SSBBSBSB", "92": "BSBBBBSB", "93": "BSSSBBBB", "94": "BSSBSBBS", "95": "SSSSSBSS", "96": "BSBSSSBB", "97": "SBSBBSSB", "98": "BBSBSSBB", "99": "BBSSSSBB" };

let rawInputs = JSON.parse(localStorage.getItem('rawInputs')) || [];
let activeTracks = JSON.parse(localStorage.getItem('activeTracks')) || [];
let historyLog = JSON.parse(localStorage.getItem('historyLog')) || [];
let lockedTrackId = localStorage.getItem('lockedTrackId') || null;

function saveData() { 
    localStorage.setItem('rawInputs', JSON.stringify(rawInputs)); 
    localStorage.setItem('activeTracks', JSON.stringify(activeTracks)); 
    localStorage.setItem('historyLog', JSON.stringify(historyLog)); 
    localStorage.setItem('lockedTrackId', lockedTrackId); 
}

function handleInput(num) {
    const bs = num >= 5 ? "B" : "S";
    activeTracks.forEach(t => { if (t.results.length < 8) t.results.push(bs === t.pattern[t.results.length] ? "âœ…" : "âŒ"); });
    
    let lockCreated = false;
    if (lockedTrackId) {
        let locked = activeTracks.find(t => t.id == lockedTrackId);
        if (locked && (locked.results[locked.results.length-1] === "âœ…" || locked.results.length === 8)) {
            const p1 = rawInputs[rawInputs.length - 1];
            lockedTrackId = null; createTrack(p1, num, true); lockCreated = true;
        }
    }
    if (rawInputs.length > 0 && !lockCreated) createTrack(rawInputs[rawInputs.length - 1], num, false);
    
    rawInputs.push(num);
    for (let i = activeTracks.length - 1; i >= 0; i--) { 
        if (activeTracks[i].results.length === 8) historyLog.unshift(activeTracks.splice(i, 1)[0]); 
    }
    saveData(); renderUI();
}

function createTrack(n1, n2, isLock) {
    const cat = n1.toString() + n2.toString();
    if (myPatterns[cat]) {
        let newT = { id: Date.now() + Math.random(), digit: cat, pattern: myPatterns[cat], results: [], wasLocked: isLock };
        activeTracks.push(newT); if (isLock || !lockedTrackId) lockedTrackId = newT.id;
    }
}

function renderUI() {
    const locked = activeTracks.find(t => t.id == lockedTrackId);
    const stepIdx = locked ? locked.results.length : -1;
    
    // Top Panel Updates
    document.getElementById('predDisplay').innerText = (locked && locked.pattern[stepIdx]) ? locked.pattern[stepIdx] : "-";
    document.getElementById('statusLabel').innerText = locked ? `LOCKED: ${locked.digit}` : "WAITING FOR CATEGORY...";
    
    const last5 = rawInputs.slice(-5);
    document.getElementById('recentDisplay').innerHTML = last5.map((v, i) => 
        `<div style="width:24px; height:24px; border-radius:50%; background:${i===last5.length-1?'var(--mint)':'#21262d'}; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; border:1px solid var(--border);">${v}</div>`
    ).join('');

    for(let i=0; i<8; i++) {
        let el = document.getElementById(`step-${i}`);
        let res = locked ? locked.results[i] : "";
        el.style.background = res==='âœ…'?'var(--green)':(res==='âŒ'?'var(--red)':'#111');
        el.innerText = res || (i+1);
    }

    // Live Monitor with Nearest Higher Level Reference Logic
    document.getElementById('liveMonitor').innerHTML = activeTracks.map(t => {
        const isLock = t.id == lockedTrackId;

        // Priority 1: Search all other live tracks for same first digit and HIGHER level
        const liveMatches = activeTracks.filter(x => 
            x.id !== t.id && 
            x.digit[0] === t.digit[0] && 
            x.results.length > t.results.length
        );
        
        let refSource = null;
        let refType = "None";

        if (liveMatches.length > 0) {
            // Priority 1: Pick the one with the level closest to current (Nearest Higher)
            refSource = liveMatches.sort((a, b) => a.results.length - b.results.length)[0];
            refType = "Live";
        } else {
            // Priority 2: Fallback to History Log (Most recent match)
            const logMatch = historyLog.find(x => x.digit[0] === t.digit[0]);
            if (logMatch) {
                refSource = logMatch;
                refType = "Log";
            }
        }
        
        const currentPos = t.results.length;
        let layers = '';
        let refRes = refSource ? refSource.results : [];
        let maxDisplay = Math.max(currentPos, refRes.length);

        for(let pos=0; pos < maxDisplay; pos++) {
            const cR = t.results[pos]; const rR = refRes[pos];
            let dotCol = (cR && rR) ? (cR === rR ? 'var(--mint)' : 'var(--red)') : 'transparent';
            layers += `<div class="cell-stack"><div class="comp-dot" style="background:${dotCol};"></div><div class="res-cell" style="color:${cR==='âœ…'?'var(--mint)':'var(--red)'}">${cR||''}</div><div class="res-cell" style="opacity:0.3; font-size:9px; color:${rR==='âœ…'?'var(--mint)':'var(--red)'}">${rR||''}</div></div>`;
        }
        
        return `<div class="live-card ${isLock?'current-lock':''}" onclick="lockedTrackId=${t.id};renderUI();">
            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px;">
                <span>${isLock?'ðŸ”’':'A'} ${t.digit} <small>L${currentPos}</small></span>
                <span style="color:var(--blue); font-weight:bold;">${t.pattern[currentPos]||'-'}</span>
            </div>
            <div class="three-layer-monitor">${layers||'...'}</div>
            <div style="font-size:8px; color:var(--silver); text-align:right; margin-top:4px; border-top:1px solid #222; padding-top:2px;">
                Ref: ${refSource ? refSource.digit : '-'}(${refType})
            </div>
        </div>`;
    }).join('');

    // History Table Update
    document.getElementById('historyBody').innerHTML = historyLog.slice(0, 30).map((h, idx) => {
        const isWin = h.results.includes('âœ…');
        return `<tr>
            <td>${historyLog.length - idx}</td>
            <td>${h.wasLocked?'ðŸ”’':'ðŸ”“'} ${h.digit}</td>
            <td style="letter-spacing:1px;">${h.results.join('')}</td>
            <td style="color:${isWin?'var(--mint)':'var(--red)'}; font-weight:bold;">${isWin?'WIN':'LOSS'}</td>
        </tr>`;
    }).join('');
}

function undoInput() { if(rawInputs.length>0){rawInputs.pop(); activeTracks.forEach(t=>t.results.pop()); saveData(); renderUI();} }
function resetData() { if(confirm("RESET ALL DATA?")){localStorage.clear(); location.reload();} }
function copyHistory() {
    let txt = historyLog.map((h,i)=> `${historyLog.length-i} | ${h.digit} | ${h.results.join('')} | ${h.results.includes('âœ…')?'WIN':'LOSS'}`).join('\n');
    navigator.clipboard.writeText(txt); alert("Copied!");
}
renderUI();
</script>
</body>
</html>
